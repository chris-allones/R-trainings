---
title: "Training Workshop on Structural Equation Modelling (SEM) using R"
subtitle: "Session 3: CFA and SEM"
output:
  xaringan::moon_reader:
    css:
      - xaringan-themer.css
      - css/presentation.css
    nature:
      slideNumberFormat: "%current%"
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: false
---

layout: true

```{r meta, echo=FALSE}
# libraries
pacman::p_load(knitr, tidyverse, psych, EFAtools, janitor, metathis)

xaringanExtra::use_share_again()
xaringanExtra::style_share_again(share_buttons = c("twitter", "facebook", "linkedin"))

meta() %>% 
  meta_name("github-repo" = "chris-allones/SEM-R-training") %>% 
  meta_social(
    title = "SEM using R",
    description = "Training on structural equation modeling using R.",
    url = "https://chris-allones.github.io/SEM-R-training/index.html",
    image = "https://chris-allones.github.io/SEM-R-training/images/preview.png",
    og_type = "website",
    og_author = "Christopher Llones",
    twitter_card_type = "summary_large_image",
    twitter_creator = "@Topenomics",
    twitter_site = "@Topenomics"
  )

```

```{r setup, echo=FALSE}
# working directory
# setwd(dir = "D:/OneDrive - KMITL/Documents/Git files/trainings/SEM_presentation/02_cfa_sem/")

options(htmltools.dir.version = FALSE,
        knitr.table.format = "html")

knitr::opts_chunk$set(
  fig.width=9, fig.height=3.5, fig.retina=3,
  out.width = "100%",
  cache = FALSE,
  echo = TRUE,
  message = FALSE, 
  warning = FALSE,
  hiline = TRUE,
  comment = "",
  fig.retina = 3
)

```

```{r xaringan-themer, echo=FALSE, warning=FALSE}
library(xaringanthemer)

xaringanExtra::use_share_again()
xaringanExtra::style_share_again(share_buttons = c("twitter", "facebook", "linkedin"))
xaringanExtra::use_tile_view()
xaringanExtra::use_extra_styles(hover_code_line = TRUE,
                                mute_unhighlighted_code = FALSE)

xaringanExtra::use_animate_css()
xaringanExtra::use_animate_all("fade")

style_duo_accent(
  primary_color = "#073b4c",
  secondary_color = "#2a9d8f",
  inverse_background_color = "#073b4c",
  inverse_header_color = "#fff",
  # title_slide_background_color = "#073b4c",
  title_slide_background_image = "img/background.jpg",
  title_slide_text_color = "#212529",
  text_font_size = "1.1rem"
)


```

```{r data-library, echo=FALSE}
# libraries
pacman::p_load(knitr, tidyverse, psych, EFAtools, janitor)

# data management
data <- haven::read_sav("data/HBAT.sav") %>%
  select(x6:x18) %>% 
  select(-x15, -x17) %>% # removing variables with below acceptable MSA
  tibble() %>% 
  clean_names(.)

hbat_data <- haven::read_sav("data/HBAT_SEM_NOMISSING.sav") %>% 
  select(JS1:SI4) %>% mutate_all(as.numeric)

```

---

## Topic overview

**1**: CFA-SEM overview

**2**: CFA-SEM with Lavaan

**3**: Defining  constructs

**4**: Developing the overall measurement model

**5**: Assessing measurement model validity

**6**: Specifying the structural model

**7**: Assessing structural model validity

---

class: middle center

# CFA-SEM overview
----

---

## What is SEM?

.leftcol[

+ A multivariate technique combining aspects of:
  + factor analysis
  + multiple regression.
  
+ Enables the researcher to simultaneously examine interrelated relationships.
  + among measured variables and latent constructs
  + between several latent constructs

+ Distinction between:
  + measurement model
  + structural model
  
]

---

## What is SEM?

.leftcol40[

#### Measurement model

+ measurement part of a full SEM model
+ confirmatory factor analysis
]

.rightcol60[
```{r echo=FALSE, out.width="72%", fig.align='center'}
knitr::include_graphics("img/measurement_part_2.jpg")
```
]

---

## What is SEM?

.leftcol40[

#### Measurement model

+ measurement part of a full SEM model
+ confirmatory factor analysis

#### Structural model

+ relationship between constucts
+ full SEM model is a combination of measurement and structural component

]

.rightcol60[
```{r echo=FALSE, out.width="70%", fig.align='center'}
knitr::include_graphics("img/structural_part_2.jpg")
```
]

---

## Basic SEM conventions

<br>

.center[
```{r echo=FALSE, out.width="70%"}
knitr::include_graphics("img/sem_convention_2.jpg")
```
]

---

class: middle center

# 2. CFA-SEM with Lavaan R package
----

---

## What is Lavaan?

.leftcol30[
+ *"developed to provide useRs, researchers, and teachers a free open-source, but commercial quality"*, Yves Rosseel (2012)

+ Check-out the [lavaan tutorial](https://lavaan.ugent.be/tutorial/index.html)
]

.rightcol70[
```{r eval=FALSE}
install.packages("lavaan")
library(lavaan)
example(cfa)
```
.code-output-scroll[
```{r echo=FALSE}
library(lavaan)
example(cfa)
```
]
]

---

## Major operators of lavaan syntax

<br>

.center[
```{r echo=FALSE, out.width="90%"}
knitr::include_graphics("img/lavaan_syntax.jpg")
```

]

---

## Major operators of lavaan syntax

.leftcol40[
#### Defining a reflective latent variable

```
model <- "F1 =~ x1 + x2 + x3 + x4"

```
<br>

```{r echo=FALSE, out.width="40%", fig.align='center'}
knitr::include_graphics("img/sample_syntax1.png")
```
]

.rightcol[
#### Estimate factor covariance

```
model <- "F1 =~ x1 + x2 + x3 + x4
          F2 =~ x5 + X6 + x6 + x8
          F1 ~~ F2"
```
<br>

```{r echo=FALSE, out.width="60%", fig.align='center'}
knitr::include_graphics("img/sample_syntax2.png")
```
]

---

## Major operators of lavaan syntax

.leftcol[

#### Estimate regression

```
model <- "F1 =~ x1 + x2 + x3 + x4
          F2 =~ x5 + X6 + x7 + x8
          F3 =~ x9 + X10 + x11 + x12
          F1 ~~ F2
          F3 ~ F1 + F2"
```
]

.rightcol[
```{r echo=FALSE, fig.align='center', out.width="70%"}
knitr::include_graphics("img/sample_syntax3.png")
```

]

---

## Major operators of lavaan syntax

.leftcol[

#### Insert a comment in the syntax

```
model <- "F1 =~ x1 + x2 + x3 + x4
          F2 =~ x5 + X6 + x7 + x8
          F3 =~ x9 + X10 + x11 + x12
          
          # covariance
          F1 ~~ F2
          
          # F3 is regressed on F1 and F2
          F3 ~ F1 + F2"
```

]

.rightcol[
```{r echo=FALSE, fig.align='center', out.width="70%"}
knitr::include_graphics("img/sample_syntax3.png")
```
]

---

## Major operators of lavaan syntax

.leftcol[

#### Label a parameter

```
model <- "F1 =~ x1 + x2 + x3 + x4
          F2 =~ x5 + X6 + x7 + x8
          F3 =~ x9 + X10 + x11 + x12
          
          # covariance
          F1 ~~ F2
          
          # F3 is regressed on F1 and F2
          F3 ~ b1*F1 + b2*F2"
```
]

.rightcol[
```{r echo=FALSE, fig.align='center', out.width="70%"}
knitr::include_graphics("img/sample_syntax4.png")
```

]

---

## Major operators of lavaan syntax

.leftcol[

#### Create a new parameter

```
model <- "F1 =~ x1 + x2 + x3 + x4
          F2 =~ x5 + X6 + x7 + x8
          F3 =~ x9 + X10 + x11 + x12
          
          # regression
          F3 ~ b1*F1 + b2*F2
          F2 ~ b3*F1

          # F1 indirect effect
          ie := b3*b2

          # F1 total effect
          te := b3*b2 + b1"

```
]

.rightcol[
```{r echo=FALSE, fig.align='center', out.width="70%"}
knitr::include_graphics("img/sample_syntax5.png")
```
]

---

class: middle center

# Main steps in SEM
----

---

## Main steps in SEM

1. Defining constructs

2. Developing the overall measurement model

3. Assessing measurement model validity

4. Specifying the structural model

5. Assessing structural model validity

---

class: center middle

# 1. Defining Constructs

----

---

## Dataset

.leftcol40[
+ HBAT company

+ HBAT is interested in understanding what affects employee's attitudes and behaviors that contributes to employee's retension.
]

.rightcol60[
```{r echo=FALSE}
rmarkdown::paged_table(hbat_data)
```
]

---

## Defining individual constructs



+ Based on literature and preliminary interviews, a study was designed focusing on five key constructs.

  + **Job satisfaction(JS)** : reactions resulting from an appraisal of one's job situation.
  
  + **Organizational commitment(OC)**: extent to which an employees identifies and feels part of HBAT.
  
  + **Staying intention(SI)**: extent to which an employee intends to continue working for HBAT.
  
  + **Environmental perceptions(EP)**: beliefs an employee has about day-to-day, physical working conditions.
  
  + **Attitudes towards coworkers(AC)**: attitudes an employee has toward the coworkers he/she interacts with on a regular basis.

---

## Defining individual constructs

.leftcol[
```{r echo=FALSE, fig.align='right'}
knitr::include_graphics("img/scale.png")
```
]

.rightcol[
```{r echo=FALSE, fig.align='right'}
knitr::include_graphics("img/scale2.png")
```
.font70[*Source: JF Hair et al. (2019) : Multivariate data analysis*]
]


---
class: center middle

# Step 2. Developing overall measurement model
----

---

## Developing overall measurement model

.leftcol30[
+ Measurement theory model (CFA) for HBAT employees

+ Direction of the relationship between factors is not yet defined.


+ Focus on confirming the specified model with empirical model (using empirical data), hence confirmatory. 
]

.rightcol70[
```{r echo=FALSE, fig.align='right', out.width="75%"}
knitr::include_graphics("img/hbat_measurement.png")
```
<center>
.font70[*Source: JF Hair et al. (2019): Multivariate data analysis*]
</center>
]

---

class: center middle

# Let's practice!


---
class: center middle

# Step 3. Assessing measurement model validity
----

---

## Model fit statistics

**Running a CFA model in lavaan**

.leftcol40[

```{r echo=FALSE}
hbat_data_lower <- hbat_data %>% clean_names()
```

```{r}
hbat_cfa_model <- "si =~ si1 + si2 + si3 + si4
              js =~ js1 + js2 + js3 + js4 + js5
              ac =~ ac1 + ac2 + ac3 + ac4
              ep =~ ep1 + ep2 + ep3 + ep4
              oc =~ oc1 + oc2 + oc3 + oc4"

hbat_cfa_fit <- cfa(model = hbat_cfa_model, data = hbat_data_lower)

```
]

.rightcol60[
```{r eval=FALSE}
summary(hbat_cfa_fit, fit.measures = TRUE)
```

.code-output-scroll40[
```{r echo=FALSE}
summary(hbat_cfa_fit, fit.measures = TRUE)
```
]
]

---

## Model fit statistics

.leftcol[
The hypothesis:

$H_0:\Sigma(\theta) = \Sigma$

$H_1: \Sigma(\theta) \ne \Sigma$

But we do not have the population covariance, so we will use the sample extimates to evaluate model fit.

$H_0: \Sigma(\hat{\theta}) = S$

$H_1: \Sigma(\hat{\theta}) = S$

]

.rightcol[

Let:

$\Sigma$ = population covariance matrix

$S$ = sample covariance matrix

$\Sigma(\theta)$ = model-implied covariance

$\Sigma(\hat{\theta})$ = sample model-implied covariance
]


---

## Model Fit Stastistics

$H_0: \Sigma(\hat{\theta}) = S$

$H_1: \Sigma(\hat{\theta}) = S$



.leftcol[

**Sample covariance $S$ **

```{r}
data_subset <- hbat_data %>% 
 select(starts_with("SI"))
cov(data_subset) %>% round(3)
```

]


.rightcol[

**Model implied covariance $\Sigma(\hat{\theta})$ **

```{r}
model <- "SI =~ SI1 + SI2 + SI3 + SI4"
model_cfa <- cfa(model, data = data_subset)
inspect(model_cfa, "cov.ov")
```
]

---

## Model fit statistics

**Known values, parameters, and degrees of freedom**

.leftcol[
+ Known values are the number of unique variance-covariance value

+ Formula: $[p(p + 1)] / 2$
where $p$ is the number of observed items

+ Example: $[4(4 + 1)]/2 = 10$

]

.rightcol[
```{r}
cov(data_subset) %>% round(3)
```
]

---

## Model fit statistics

**Known values, parameters, and degrees of freedom**

.leftcol[
+ The known values are the primary restrictions of how many parameters( $k$ ) we can estimate.

+ e.g., 4 loading and 4 error variance
]

.rightcol[
```{r echo=FALSE, out.width="50%", fig.align='center'}
knitr::include_graphics("img/staying_intention.png")
```
]

---
## Model fit statistics

**Known values, parameters, and degrees of freedom**


.leftcol[

degrees of freedom ( $df$ )

$df$ = known values - estimated parameters
$df = [p(p+1)] / 2 - k$

e.g., $df = 10 - 8 = 2$

]

.rightcol[

+ 10 unique variance-covariance values

```{r echo=FALSE}
cov(data_subset) %>% round(3)
```

+ 8 parameters to be estimated

```{r echo=FALSE, out.width="25%", fig.align='center'}
knitr::include_graphics("img/staying_intention.png")
```
]


---
## Model fit statistics

**Known values, parameters, and degrees of freedom**


.leftcol40[

degrees of freedom ( $df$ )

e.g., $df = 10 - 8 = 2$

<br>

*In a factor with 3 observed indicator, what is the degrees of freedom?
*
]

.rightcol60[

```{r eval=FALSE}
model <- "SI =~ SI1 + SI2 + SI3 + SI4"
model_cfa <- cfa(model, data = data_subset)
summary(model_cfa)
```

.code-output-scroll40[
```{r echo=FALSE}
model <- "SI =~ SI1 + SI2 + SI3 + SI4"
model_cfa <- cfa(model, data = data_subset)
summary(model_cfa)
```
]
]

---

## Summary output

.leftcol20[

**Loadings**

#### 1. Marker method
+ fixes the first loading of each factor to 1.


#### 2. factor variance standardization 

+ fixed variance of each factor to 1 but freely estimates all loadings.

]

.rightcol80[

```{r eval=FALSE}
cfa_fit <- cfa(hbat_cfa_model, data = hbat_data_lower)
summary(cfa_fit, standardized = TRUE)
```

.code-output-scroll40[
```{r echo=FALSE}
cfa_fit <- cfa(hbat_cfa_model, data = hbat_data_lower)
summary(cfa_fit, standardized = TRUE)
```
]
]

---

## Summary output

.leftcol20[

**Covariances**

]

.rightcol80[

```{r eval=FALSE}
cfa_fit <- cfa(hbat_cfa_model, data = hbat_data_lower)
summary(cfa_fit, standardized = TRUE)
```

.code-output-scroll40[
```{r echo=FALSE}
cfa_fit <- cfa(hbat_cfa_model, data = hbat_data_lower)
summary(cfa_fit, standardized = TRUE)
```
]
]



---

## Summary output

.leftcol20[

**Error variances**

Refer to unique variance that the factor unable to account for. 

Similar to the error term in OLS, hence error variance.
]

.rightcol80[

```{r eval=FALSE}
cfa_fit <- cfa(hbat_cfa_model, data = hbat_data_lower)
summary(cfa_fit, standardized = TRUE)
```

.code-output-scroll40[
```{r echo=FALSE}
cfa_fit <- cfa(hbat_cfa_model, data = hbat_data_lower)
summary(cfa_fit, standardized = TRUE)
```
]
]

---

## Fit indices

.leftcol40[
#### Goodness of fit indices

+ Goodness-of-fit index (GFI)
+ Adjusted goodness-fit-index (AGFI)
+ Comparative fit index (CFI)
+ Normed fit index (NFI)
+ Non-normed fit index (NNF)

#### Badness of fit indices

+ Standard root mean square of the residuals (SRMR)
+ Root mean square error of approximation (RMSEA)
]


.rightcol60[
```{r echo=FALSE, out.width="80%", fig.align='center'}
knitr::include_graphics("img/sample_gof.png")
```

.font70[*Sample GOF results from W. Shiau & M. Luo (2013). Continuance intention of blog users: The impact of perceived enjoyment, habit, user involvement and blogging time.*]
]

---

## Fit indices

.leftcol40[
#### Goodness of fit indices

+ Goodness-of-fit index (GFI)
+ Adjusted goodness-fit-index (AGFI)
+ Comparative fit index (CFI)
+ Normed fit index (NFI)
+ Non-normed fit index (NNF)
]

.rightcol60[
```{r}
fitMeasures(cfa_fit)
```
]

---

## Fit indices

.leftcol40[
#### Goodness of fit indices

+ Goodness-of-fit index (GFI)
+ Adjusted goodness-fit-index (AGFI)
+ Comparative fit index (CFI)
+ Normed fit index (NFI)
+ Non-normed fit index (NNF)
]

.rightcol60[
```{r}
fitMeasures(cfa_fit,  fit.measures = c("gfi", "agfi", "cfi", "nfi", "nnfi"))
```
]

---

## Fit indices

.leftcol40[
#### Badness of fit indices

+ Standard root mean squrare residual (SRMR)
+ Root mean square error of approximation (RMSEA)
]

.rightcol60[
```{r}
fitMeasures(cfa_fit,  fit.measures = c("srmr", "rmsea"))
```
]

---

## Reliability and validity test

.leftcol30[
#### Reliability test
+ Composite reliability

#### Validity test
+ Convergent validity
+ Discriminant validity
]

.rightcol70[
```{r echo=FALSE, out.width="95%"}
knitr::include_graphics("img/reliability_validity.png")
```

.font70[*Source: A. Hou, W. Shiau, & R. Shang (2019). The involvement paradox. The role of cognitive absorption in mobile instant messaging user satisfaction.*]
]

---

## Reliability and validity test

.leftcol[
+ Composite reliability: `alpha` > `0.70`

+ Convergent validity: AVE (`avevar`) > `0.50`

+ Discriminant validity: `omega` > `0.7`
]


.rightcol[
```{r eval=FALSE}
library(semTools)
reliability(cfa_fit) %>% round(3)
```

```{r echo=FALSE}
semTools::reliability(cfa_fit) %>% round(3)
```

]

---
class: middle center

# Let's practice

---

class: center middle

# Step 4: Specifying the structural model
----

---
## CFA model to structural model
```{r echo=FALSE, out.width="60%", fig.align='center'}
knitr::include_graphics("img/cfa_sem.png")
```

---

## Defining structural model

#### Hypothesis:

+ H1: Environmental perceptions are positively related to job satisfaction.
+ H2: Environmental perceptions are positively related to organizational commitment.
+ H3: Attitudes toward coworkers are positively related to job satisfaction.
+ H4: Attitudes toward coworkers are positively related to organizational commitment.
+ H5: Job satisfaction is related positively to organizational commitment.
+ H6: Job satisfaction is related  positively to staying intentions.
+ H7: Organizational commitment is related positively to staying intention.

---

## Defining structural model

```{r echo=FALSE, fig.align='center', out.width="60%"}
knitr::include_graphics("img/structural_model.png")
```


---

class: center middle

# Let's practice

---

## Defining structural model

.leftcol30[

```{r echo=FALSE}
sem_model <- "SI =~ SI1 + SI2 + SI3 + SI4
              JS =~ JS1 + JS2 + JS3 + JS4 + JS5
              AC =~ AC1 + AC2 + AC3 + AC4
              EP =~ EP1 + EP2 + EP3 + EP4
              OC =~ OC1 + OC2 + OC3 + OC4
              EP ~~ AC
              JS ~ H1*EP + H3*AC
              OC ~ H2*EP + H4*AC + H5*JS
              SI ~ H6*JS + H7*OC"

sem_fit <- sem(model = sem_model, data = hbat_data)
```

```{r eval=FALSE}
library(semPlot)
semPaths(object = sem_fit,
         what = "std",
         layout = "tree2",
         intercepts = FALSE,
         residuals = FALSE)
```
]

.rightcol70[
```{r echo=FALSE, out.width="180%", fig.align='center'}
knitr::include_graphics("img/sempath2.svg")
```
]

---

## Defining structural model

```{r echo=FALSE, out.width="70%", fig.align='center'}
knitr::include_graphics("img/structural_result.svg")
```

---

## GOF measures between structural and CFA model

.leftcol40[
```{r eval=FALSE}
gof_indices <- c('chisq', 'df','pvalue', "gfi", 
                 'rmsea', 'rmr', 'srmr', 'nfi', 
                 'nnfi', 'cfi', 'agfi')
fitmeasures(sem_fit, fit.measures = gof_indices)
fitmeasures(cfa_fit, fit.measures = gof_indices)
```

```{r echo=FALSE}
gof_indices <- c('chisq', 'df','pvalue', "gfi", 
                 'rmsea', 'rmr', 'srmr', 'nfi', 
                 'nnfi', 'cfi', 'agfi')
fitmeasures(sem_fit, fit.measures = gof_indices)
fitmeasures(cfa_fit, fit.measures = gof_indices)
```
]

.rightcol60[
```{r echo=FALSE, out.width="90%", fig.align='right'}
knitr::include_graphics("img/fit_indices.png")
```
]

---

## What's next?

.leftcol40[
+ Modification indeces

+ Handling heywood cases

+ Comparing competing models

+ Formative scales in SEM

+ Higher-order factor analysis

+ Multigroup analysis
]

.rightcol60[
```{r echo=FALSE, out.width="70%", fig.align='center'}
knitr::include_graphics("img/we_can.gif")
```
]

---

class: middle center

# Thank you!

#### Slides created via the R packages:

.leftcol[
<img src="img/xaringan.png" style="display:inline-block; margin: 0" width=20%/> 

### xaringan by Yihui
]

.rightcol[
<img src="img/xaringanthemer.png" style="display:inline-block; margin: 0" width=25%/> 

### xaringanthemer and xaringanExtra by Garrick
]





